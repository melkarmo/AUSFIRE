<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body { 
      margin:0;
      position:fixed;
      top:0;
      right:0;
      bottom:0;
      left:0;
      text-align: center;
    }
    h1 { text-align: center; }
  </style>
</head>

<body>

  <h1>AUSFIRE</h1>

  <div id="grid"></div>
  
  <script>

var svg = d3.select("#grid")
.append("svg")
.attr("width", 960)
.attr("height", 500)

var states = [
    {
        name: 'Northern Territory', postal: 'NT',
        x: 20, y: 20, w: 5, h: 5, nb_div: 20,
        area: 1419630.0, forest1: 42588.9, forest2: 237000.0
    },
    {
        name: 'Queensland', postal: 'QLD',
        x: 20 + 120, y: 20, w: 5, h: 5, nb_div: 20,
        area: 1851736.0, forest1: 370347.2, forest2: 518000.0
    },
    {
        name: 'South Australia', postal: 'SA',
        x: 20 + 2*120, y: 20, w: 5, h: 5, nb_div: 20,
        area: 1044353.0, forest1: 31330.59, forest2: 51000.0
    },
    {
        name: 'Tasmania', postal: 'TAS',
        x: 20 + 3*120, y: 20, w: 5, h: 5, nb_div: 20,
        area: 90758.0, forest1: 58992.7, forest2: 37000.0
    },
    {
        name: 'Victoria', postal: 'VIC',
        x: 20 + 4*120, y: 20, w: 5, h: 5, nb_div: 20,
        area: 237657.0, forest1: 83179.95, forest2: 82000.0
    },
    {
        name: 'Western Australia', postal: 'WA',
        x: 20 + 5*120, y: 20, w: 5, h: 5, nb_div: 20,
        area: 2642753.0, forest1: 52855.06, forest2: 210000.0
    },
    {
        name: 'New South Wales', postal: 'NSW',
        x: 20 + 6*120, y: 20, w: 5, h: 5, nb_div: 20,
        area: 812310.0, forest1: 97477.2, forest2: 205400.0
    }
]

function initial_draw() {

    states.forEach(function(elt) {

        var gridData = new Array();
        var xpos = elt.x; var ypos = elt.y; var width = elt.w;
        var height = elt.h; var nb_div = elt.nb_div; var postal = elt.postal;
        for (var row = 0; row < nb_div; row++) {
            for (var column = 0; column < nb_div; column++) {
                gridData.push({
                    x: xpos,
                    y: ypos,
                    width: width,
                    height: height,
                    name: postal + '_' + row + '_' + column
                })
                xpos += width;
            }
            xpos = elt.x;
            ypos += height; 
        }

        svg.selectAll()
        .data(gridData)
        .enter()
        .append("rect")
        .attr("class", function(d) { return d.name; })
        .attr("x", function(d) { return d.x; })
        .attr("y", function(d) { return d.y; })
        .attr("width", function(d) { return d.width; })
        .attr("height", function(d) { return d.height; })
        .style("fill", "#fff")
        .style("stroke", "#222");

    })
}

initial_draw();

function colorize(myDate, myState) {

  d3.csv("https://raw.githubusercontent.com/melkarmo/AUSFIRE/master/bystate/" + myState.name + ".csv", function(data) {

    var fire_area = 0; var old_fire_area = 0;
    var state_nb_div = myState.nb_div; var forest_area = myState.forest1; var postal_code = myState.postal;

    data.forEach(function(d) {
        if (d.acq_date === myDate){
          fire_area = parseFloat(d.fire_area);
        }
    })
    console.log(fire_area);
      
    myDateFormatted = new Date(myDate)
    old_fire_area = d3.sum(data, function(d) {
        var acq_dateFormatted = new Date(d.acq_date)
        if (acq_dateFormatted < myDateFormatted) {
          return parseFloat(d.fire_area)
        } else {
          return 0
        }
    });
    console.log(old_fire_area);

    var seuil_fire = parseInt(state_nb_div * state_nb_div * fire_area / forest_area);
    var seuil_old_fire = seuil_fire + parseInt(state_nb_div * state_nb_div * old_fire_area / forest_area);
    var compteur = 0
    for (var row = 0; row < state_nb_div; row++) {
        for (var column = 0; column < state_nb_div; column++) {
            compteur += 1;
            if (compteur <= seuil_fire) {
              svg.select("."+ postal_code + "_" + row + "_" + column)
              .style("fill", "red")
            } else if (compteur <= seuil_old_fire) {
              svg.select("."+ postal_code + "_" + row + "_" + column)
              .style("fill", "grey")
            } else {
              svg.select("."+ postal_code + "_" + row + "_" + column)
              .style("fill", "limegreen")
            }
        }
    }

  })

}

states.forEach(function(d){
  colorize('2020-01-06', d)
})

  </script>
</body>
